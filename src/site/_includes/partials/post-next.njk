{% from 'macros/tag-chips.njk' import tagChips with context %}

{#
  Grab the ToC contents for headings ToC. This powers the list of headings
  that appears on the right-hand side of the page. Unfortunately our use of
  the word 'toc' is a bit overloaded :P
  TODO: The courseToc filter is only used to define the ToC for courses, but
  it's basically the same thing we use on developer.chrome.com and it would be
  nice to use it for articles as well. Currently we have a different toc design
  for those but it's a bit clunky and we should replace it with this.
#}
{% set tocContents %}
  {{- content | courseToc | safe -}}
{% endset %}

<div class="post wrapper" data-flush>
  {% if path === undefined  %}
    {% set postPaths = page | getPaths %}
    {# Use first found path as a default path. #}
    {% set path = paths[postPaths[0]] %}
  {% endif %}
  {% set safeTitle = title | trim | md | safe %}

  {% if hero %}
    {% Hero {
      hero: hero,
      alt: alt,
      heroPosition: hero_position,
      heroFit: hero_fit
    } %}
  {% endif %}
 
  <div class="sidebar region flex-align-start flex-dir-rev flex-wrap-no">
    {% include 'partials/toc-side.njk' %}
    {# 
      TODO: The legacy rollout task can be removed 
      when the design system has been full rolled-out across the site 
    #}
    <article class="prose legacy-rollout">
      <header class="flow gap-bottom-size-3">
        {% if 'blog' in tags or crumbs %}
          <nav class="breadcrumbs" aria-label="breadcrumbs">
            <ul class="breadcrumbs__list" role="list">
              <li>
                <a
                  class="gc-analytics-event"
                  data-category="web.dev"
                  data-label="post, home breadcrumb"
                  data-action="click"
                  href="/"
                >
                  {{site.titleVariation}}
                </a>
              </li>
              {% if 'blog' in tags %}
              <li>
                <a
                  class="gc-analytics-event"
                  data-category="web.dev"
                  data-label="post, path breadcrumb"
                  data-action="click"
                  href="/blog"
                >
                  All articles
                </a>
              </li>
              {% elif crumbs %}
                {% for crumb in crumbs %}
                  <li>
                    <a
                      class="gc-analytics-event"
                      data-category="web.dev"
                      data-label="post, path breadcrumb"
                      data-action="click"
                      href="{{crumb[1]}}"
                    >
                      {{crumb[0]}}
                    </a>
                  </li>
                {% endfor %}
              {% endif %}
            </ul>
          </nav>
        {% endif %}

        <h1 id="{{ safeTitle | slugify }}">{{ safeTitle }}</h1>
        {% if subhead %}
          <p class="color-mid-text flow-space-base">
            {{ subhead | md | safe }}
          </p>
        {% endif %}

        {% if date %}
          <div>
            <time>{{date | prettyDate}}</time>
            {% if updated %} â€” {{ 'i18n.common.updated' | i18n((locale)) }} <time>{{ updated | prettyDate }}</time> {% endif %}
          </div>
        {% endif %}

        {% set languageListHtml %}{% LanguageList page.url, lang %}{% endset %}
        {% if languageListHtml %}
        <div class="flow">
          {{ languageListHtml | safe }}
        </div>
        {% endif %}

        {% SignPosts page.fileSlug %}

        {% if authors %}
          <div class="cluster">
            {% for author in authors %}
              {% Author {
                id: authorKey,
                author: collections.authors[author],
                showSocialMedia: true,
                locale: locale
                }
              %}
            {% endfor %}
          </div>
        {% endif %}
      </header>

      {% if draft and site.env === 'dev' %}
        <div class="banner bg-state-warn-bg color-core-text">
          <p><strong>{{ 'i18n.post.is_draft' | i18n(locale) }}</strong></p>
        </div>
      {% endif %}
      
      {% include 'partials/toc-inner.njk' %}
      
      {{ content | safe }}

      {% if stack_overflow_tag %}
        {% StackOverflow stack_overflow_tag %}
      {% endif %}

      {{ tagChips(tags) }}

      <div class="flow">
        <span>
          {% if updated %}
          {{ 'i18n.post.last_updated' | i18n(locale) }}: <time>{{ updated | prettyDate }}</time>
          {% else %}
          {{ 'i18n.post.last_updated' | i18n(locale) }}: <time>{{ date | prettyDate }}</time>
          {% endif %}
        </span>
        <a
          href="{{ page.inputPath | githubLink }}"
        >
          {{ 'i18n.post.improve_article' | i18n(locale) }}
        </a>
      </div>

      {% if codelabs %}
        {% CodelabsCallout codelabs, lang %}
      {% endif %}

      {% include 'partials/subscribe-action-next.njk' %}
    </article>
  </div>

  {% if 'blog' in tags %}
    {# Find next blog post #}
    {% ArticleNavigation {
      back: '/blog',
      backLabel: 'Return to all articles'
    } %}
  {% elif path %}
    {# Find next item in this learning path #}
    {% ArticleNavigation {
      back: '/' + path.slug,
      backLabel: 'Return to all articles'
    } %}
  {% endif %}
</div>
